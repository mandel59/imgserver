<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        #image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .image-thumbnail {
            width: 200px;
            height: 200px;
            object-fit: cover;
            cursor: pointer;
        }
        #controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Image Viewer</h1>
    
    <div id="controls">
        <select id="sort-option">
            <option value="name">ÂêçÂâçÈ†Ü</option>
            <option value="date">Êõ¥Êñ∞Êó•ÊôÇÈ†Ü</option>
        </select>
    </div>

    <div id="breadcrumbs-container"></div>

    <div id="image-container"></div>

    <script>
        let currentPath = '';
        
        // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÇíÂèñÂæó
        async function fetchItems() {
            const sortOption = document.getElementById('sort-option').value;
            const response = await fetch(`/api/images?sort=${sortOption}&path=${encodeURIComponent(currentPath)}`);
            return await response.json();
        }

        // „ÇΩ„Éº„Éà„Ç™„Éó„Ç∑„Éß„É≥Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
        document.getElementById('sort-option').addEventListener('change', async () => {
            const items = await fetchItems();
            renderItemList(items);
        });

        // ÂàùÊúüÂåñÂá¶ÁêÜ
        async function init() {
            const items = await fetchItems();
            renderItemList(items);
        }

        // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Áî®Ë¶ÅÁ¥†
        const modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.backgroundColor = 'rgba(0,0,0,0.9)';
        modal.style.zIndex = '1000';
        modal.style.justifyContent = 'center';
        modal.style.alignItems = 'center';
        modal.style.flexDirection = 'column';

        const modalImg = document.createElement('img');
        modalImg.style.width = '100vw';
        modalImg.style.height = '100vh';
        modalImg.style.objectFit = 'contain';
        modalImg.style.padding = '20px';
        modalImg.style.boxSizing = 'border-box';

        const closeBtn = document.createElement('span');
        closeBtn.textContent = '√ó';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '20px';
        closeBtn.style.right = '30px';
        closeBtn.style.color = 'white';
        closeBtn.style.fontSize = '40px';
        closeBtn.style.cursor = 'pointer';

        modal.appendChild(closeBtn);
        modal.appendChild(modalImg);
        document.body.appendChild(modal);

        // „Çπ„ÉØ„Ç§„ÉóÊìç‰Ωú„ÅÆË®≠ÂÆö
        const hammer = new Hammer(modal);
        hammer.on('swipeleft', () => {
            if (currentImages.length === 0) return;
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            modalImg.src = `/images/${currentImages[currentImageIndex].path}`;
        });
        hammer.on('swiperight', () => {
            if (currentImages.length === 0) return;
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            modalImg.src = `/images/${currentImages[currentImageIndex].path}`;
        });

        let currentImageIndex = 0;
        let currentImages = [];

        // „Ç¢„Ç§„ÉÜ„É†‰∏ÄË¶ß„ÇíË°®Á§∫
        function renderItemList(items) {
            const container = document.getElementById('image-container');
            container.innerHTML = '';
            
            // „Éë„É≥„Åè„Åö„É™„Çπ„Éà„ÇíË°®Á§∫
            const breadcrumbsContainer = document.getElementById('breadcrumbs-container');
            breadcrumbsContainer.innerHTML = '';
            
            const breadcrumbs = document.createElement('div');
            breadcrumbs.style.marginBottom = '10px';
            
            const rootLink = document.createElement('a');
            rootLink.textContent = 'Home';
            rootLink.href = '#';
            rootLink.style.marginRight = '5px';
            rootLink.addEventListener('click', async (e) => {
                e.preventDefault();
                currentPath = '';
                const items = await fetchItems();
                renderItemList(items);
            });
            breadcrumbs.appendChild(rootLink);
            
            if (currentPath) {
                const parts = currentPath.split('/');
                let path = '';
                parts.forEach(part => {
                    path = path ? `${path}/${part}` : part;
                    const span = document.createElement('span');
                    span.textContent = ' > ';
                    breadcrumbs.appendChild(span);
                    
                    const link = document.createElement('a');
                    link.textContent = part;
                    link.href = '#';
                    link.style.marginRight = '5px';
                    link.addEventListener('click', async (e) => {
                        e.preventDefault();
                        currentPath = path;
                        const items = await fetchItems();
                        renderItemList(items);
                    });
                    breadcrumbs.appendChild(link);
                });
            }
            
            breadcrumbsContainer.appendChild(breadcrumbs);
            
            // „Ç¢„Ç§„ÉÜ„É†„ÇíË°®Á§∫
            currentImages = items.filter(item => !item.isDirectory);
            
            items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.style.width = '200px';
                itemElement.style.height = '200px';
                itemElement.style.display = 'flex';
                itemElement.style.flexDirection = 'column';
                itemElement.style.alignItems = 'center';
                itemElement.style.justifyContent = 'center';
                itemElement.style.cursor = 'pointer';
                
                if (item.isDirectory) {
                    // „Éá„Ç£„É¨„ÇØ„Éà„É™Ë°®Á§∫
                    itemElement.innerHTML = `
                        <div style="font-size: 60px;">üìÅ</div>
                        <div>${item.name}</div>
                    `;
                    itemElement.addEventListener('click', async () => {
                        currentPath = item.path;
                        const items = await fetchItems();
                        renderItemList(items);
                        // URL„ÇíÊõ¥Êñ∞
                        history.pushState({path: currentPath}, '', `?path=${encodeURIComponent(currentPath)}`);
                    });
                } else {
                    // ÁîªÂÉèË°®Á§∫
                    const img = document.createElement('img');
                    img.src = `/images/${item.path}`;
                    img.style.width = '100%';
                    img.style.height = '180px';
                    img.style.objectFit = 'cover';
                    img.addEventListener('click', () => {
                        const index = currentImages.findIndex(i => i.path === item.path);
                        currentImageIndex = index;
                        modalImg.src = `/images/${item.path}`;
                        modal.style.display = 'flex';
                        // URL„ÇíÊõ¥Êñ∞
                        history.pushState({imageIndex: index}, '', `?image=${encodeURIComponent(item.path)}`);
                    });
                    itemElement.appendChild(img);
                    itemElement.appendChild(document.createTextNode(item.name));
                }
                
                container.appendChild(itemElement);
            });
        }


        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        document.addEventListener('keydown', (e) => {
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') {
                    modal.style.display = 'none';
                } else if (e.key === 'ArrowRight') {
                    // Âè≥Áü¢Âç∞„Ç≠„Éº„ÅßÊ¨°„ÅÆÁîªÂÉè
                    currentImageIndex = (currentImageIndex + 1) % currentImages.length;
                    modalImg.src = `/images/${currentImages[currentImageIndex].path}`;
                } else if (e.key === 'ArrowLeft') {
                    // Â∑¶Áü¢Âç∞„Ç≠„Éº„ÅßÂâç„ÅÆÁîªÂÉè
                    currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
                    modalImg.src = `/images/${currentImages[currentImageIndex].path}`;
                }
            }
        });

        // URL„Åã„ÇâÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
        function restoreFromURL() {
            const params = new URLSearchParams(window.location.search);
            const imagePath = params.get('image');
            const pathParam = params.get('path');
            
            if (imagePath) {
                const index = currentImages.findIndex(i => i.path === decodeURIComponent(imagePath));
                if (index !== -1) {
                    currentImageIndex = index;
                    modalImg.src = `/images/${decodeURIComponent(imagePath)}`;
                    modal.style.display = 'flex';
                }
            } else if (pathParam) {
                currentPath = decodeURIComponent(pathParam);
                fetchItems().then(items => renderItemList(items));
            }
        }

        // Êàª„Çã/ÈÄ≤„ÇÄÊìç‰Ωú„Å´ÂØæÂøú
        window.addEventListener('popstate', (e) => {
            if (e.state) {
                if (e.state.imageIndex !== undefined) {
                    currentImageIndex = e.state.imageIndex;
                    modalImg.src = `/images/${currentImages[currentImageIndex].path}`;
                    modal.style.display = 'flex';
                } else if (e.state.path !== undefined) {
                    currentPath = e.state.path;
                    fetchItems().then(items => renderItemList(items));
                }
            } else {
                modal.style.display = 'none';
            }
        });

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            init().then(() => {
                restoreFromURL();
            });
        });
    </script>
</body>
</html>
